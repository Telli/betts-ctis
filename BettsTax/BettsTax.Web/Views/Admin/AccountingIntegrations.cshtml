@{
    ViewData["Title"] = "Accounting Integrations";
    Layout = "_AdminLayout";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Accounting System Integrations</h4>
                </div>
                <div class="card-body">
                    <!-- Provider Selection Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5>Available Accounting Systems</h5>
                            <div class="row" id="accounting-providers">
                                <!-- Dynamic provider cards will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Active Connections Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5>Active Connections</h5>
                            <div class="table-responsive">
                                <table class="table table-striped" id="connections-table">
                                    <thead>
                                        <tr>
                                            <th>Provider</th>
                                            <th>Company</th>
                                            <th>Status</th>
                                            <th>Last Sync</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="connections-tbody">
                                        <!-- Dynamic connection rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Sync History Section -->
                    <div class="row">
                        <div class="col-md-12">
                            <h5>Recent Sync History</h5>
                            <div class="table-responsive">
                                <table class="table table-sm" id="sync-history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Provider</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                            <th>Records</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sync-history-tbody">
                                        <!-- Dynamic sync history rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Configuration Modal -->
<div class="modal fade" id="connectionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Accounting Integration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connection-form">
                    <input type="hidden" id="provider-type" name="providerType" />
                    
                    <div class="mb-3">
                        <label for="company-name" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="company-name" name="companyName" required>
                    </div>

                    <div class="mb-3">
                        <label for="environment" class="form-label">Environment</label>
                        <select class="form-select" id="environment" name="environment">
                            <option value="sandbox">Sandbox (Testing)</option>
                            <option value="production">Production</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        You will be redirected to <span id="provider-name-display"></span> to authorize the connection.
                        Please ensure you have administrative access to your accounting system.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="connect-btn">
                    <i class="fas fa-link me-2"></i>Connect to <span id="connect-provider-name"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Account Mapping Modal -->
<div class="modal fade" id="mappingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Account Mapping Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tax System Accounts</h6>
                        <div id="tax-accounts-list" class="list-group">
                            <!-- Tax system accounts will be loaded here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Accounting System Accounts</h6>
                        <div id="accounting-accounts-list" class="list-group">
                            <!-- Accounting system accounts will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Current Mappings</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="mappings-table">
                                <thead>
                                    <tr>
                                        <th>Tax Account</th>
                                        <th>Accounting Account</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mappings-tbody">
                                    <!-- Account mappings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="save-mappings-btn">
                    <i class="fas fa-save me-2"></i>Save Mappings
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadProviders();
            loadConnections();
            loadSyncHistory();
            
            // Auto-refresh every 30 seconds
            setInterval(function() {
                loadConnections();
                loadSyncHistory();
            }, 30000);
        });

        function loadProviders() {
            $.get('/api/accounting-integrations/providers', function(data) {
                const container = $('#accounting-providers');
                container.empty();
                
                data.forEach(provider => {
                    const card = `
                        <div class="col-md-4 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-building fa-3x text-primary mb-2"></i>
                                    <h6 class="card-title">${provider.name}</h6>
                                    <p class="card-text small">${provider.description}</p>
                                    <button class="btn btn-primary btn-sm" onclick="configureConnection('${provider.type}', '${provider.name}')">
                                        <i class="fas fa-plus me-1"></i>Connect
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.append(card);
                });
            });
        }

        function loadConnections() {
            $.get('/api/accounting-integrations/connections', function(data) {
                const tbody = $('#connections-tbody');
                tbody.empty();
                
                if (data.length === 0) {
                    tbody.append('<tr><td colspan="5" class="text-center">No active connections</td></tr>');
                    return;
                }
                
                data.forEach(connection => {
                    const statusBadge = connection.isActive ? 
                        '<span class="badge bg-success">Active</span>' : 
                        '<span class="badge bg-danger">Inactive</span>';
                    
                    const row = `
                        <tr>
                            <td>${connection.providerType}</td>
                            <td>${connection.companyName}</td>
                            <td>${statusBadge}</td>
                            <td>${formatDate(connection.lastSyncDate)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="testConnection(${connection.id})">
                                    <i class="fas fa-check-circle"></i> Test
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="syncData(${connection.id})">
                                    <i class="fas fa-sync"></i> Sync
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="configureMappings(${connection.id})">
                                    <i class="fas fa-map"></i> Mappings
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="disconnectProvider(${connection.id})">
                                    <i class="fas fa-unlink"></i> Disconnect
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            });
        }

        function loadSyncHistory() {
            $.get('/api/accounting-integrations/sync-history', function(data) {
                const tbody = $('#sync-history-tbody');
                tbody.empty();
                
                if (data.length === 0) {
                    tbody.append('<tr><td colspan="6" class="text-center">No sync history available</td></tr>');
                    return;
                }
                
                data.slice(0, 10).forEach(sync => {
                    const statusBadge = sync.status === 'Success' ? 
                        '<span class="badge bg-success">Success</span>' : 
                        '<span class="badge bg-danger">Failed</span>';
                    
                    const row = `
                        <tr>
                            <td>${formatDateTime(sync.syncDate)}</td>
                            <td>${sync.providerType}</td>
                            <td>${sync.syncType}</td>
                            <td>${statusBadge}</td>
                            <td>${sync.recordsProcessed}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" onclick="viewSyncDetails(${sync.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            });
        }

        function configureConnection(providerType, providerName) {
            $('#provider-type').val(providerType);
            $('#provider-name-display').text(providerName);
            $('#connect-provider-name').text(providerName);
            $('#connectionModal').modal('show');
        }

        $('#connect-btn').click(function() {
            const formData = {
                providerType: $('#provider-type').val(),
                companyName: $('#company-name').val(),
                environment: $('#environment').val()
            };
            
            $.post('/api/accounting-integrations/authenticate', formData, function(response) {
                if (response.success) {
                    // Redirect to OAuth authorization URL
                    window.location.href = response.authorizationUrl;
                } else {
                    alert('Error initiating connection: ' + response.error);
                }
            });
        });

        function testConnection(connectionId) {
            $.post(`/api/accounting-integrations/test/${connectionId}`, function(response) {
                if (response.success) {
                    toastr.success('Connection test successful');
                } else {
                    toastr.error('Connection test failed: ' + response.error);
                }
            });
        }

        function syncData(connectionId) {
            $.post(`/api/accounting-integrations/sync/${connectionId}`, function(response) {
                if (response.success) {
                    toastr.success('Data sync initiated successfully');
                    setTimeout(() => {
                        loadConnections();
                        loadSyncHistory();
                    }, 2000);
                } else {
                    toastr.error('Sync failed: ' + response.error);
                }
            });
        }

        function configureMappings(connectionId) {
            // Load mapping configuration
            $('#mappingModal').modal('show');
            // Implementation for account mappings would go here
        }

        function disconnectProvider(connectionId) {
            if (confirm('Are you sure you want to disconnect this accounting system?')) {
                $.ajax({
                    url: `/api/accounting-integrations/connections/${connectionId}`,
                    type: 'DELETE',
                    success: function(response) {
                        if (response.success) {
                            toastr.success('Connection removed successfully');
                            loadConnections();
                        } else {
                            toastr.error('Failed to remove connection: ' + response.error);
                        }
                    }
                });
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Never';
            return new Date(dateString).toLocaleDateString();
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Never';
            return new Date(dateString).toLocaleString();
        }

        function viewSyncDetails(syncId) {
            // Implementation for viewing sync details would go here
            alert('Sync details for ID: ' + syncId);
        }
    </script>
}